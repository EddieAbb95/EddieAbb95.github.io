<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="author" content="">
    <meta name="generator" content="Hugo 0.37" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://EddieAbb95.github.io/css/style.css" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type="text/css">
    <link rel="alternate" href="https://EddieAbb95.github.io/index.xml" type="application/rss+xml" title="Eddie Abbondanzio">

    <title>
        
        No Mans Blocks - 4/8/18  - Eddie Abbondanzio 
    </title>
</head>
    
<body>
    <header>
        <div class="container clearfix">
        
        <a class="path" href="https://EddieAbb95.github.io/">Home</a>

        
        <div class="right">
            
            
            
            
            
            <a class="path" href="/page/about/">About Me</a>
        </div>
      </div>
    </header>

<div class="container">


<main role="main" class="article">
  
<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2018-04-08">April 08, 2018</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="https://EddieAbb95.github.io/categories/nomansblocks">NoMansBlocks</a>

    </span>


  </div>
  <h1 class="headline" itemprop="headline">No Mans Blocks - 4/8/18</h1>
  <section class="body" itemprop="articleBody" style="width: 100%;">
    

<h2 id="building-up-the-network-logic">Building Up the Network Logic</h2>

<p>While this week may not have much to show for it has built a solid foundation for networking. I spent some time refactoring the pre-existing network logic to try to clean things up. I really didn&rsquo;t like how the NetServerManager and NetClientManager derived from a base class of NetManager that had a NetMessageProcessor component. It was gross having to call that and subscribe to it&rsquo;s message events. I also didn&rsquo;t care for how each message had it&rsquo;s own event. To try to curtail this redundancy I came up with the following solution.</p>

<p>This networking set up is built on top of the Lidgren networking library. I wanted to abstract away from the Lidgren aspect since it&rsquo;s kinda low level, but I didn&rsquo;t want to go over the top at the same time. I based my setup from this <a href="https://dirkkok.wordpress.com/2012/02/20/lets-make-a-multiplayer-game-part-1/">site&rsquo;s</a> tutorial and applied a few custom tweaks to it.</p>

<p>To reduce redundant code and prevent potential logic errors from arising I changed NetMessage to an abstract class, and added a message category to the class. Now instead of requiring an unique event for each message type I only had to add one per category. Since most components of the game would require several messages it made sense to group them together instead of having to track multiple events per component.</p>

<p>The NetManager base class is responsible for checking and sending out message over the network. It allows for the server and client to be abstract away from the regular game logic as well. Below is the method for checking for messages.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// Check to see if any messages have come in from the network.
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> CheckForMessages() {
    NetIncomingMessage inMsg;

    <span style="color:#66d9ef">while</span>((inMsg = ReadMessage()) != <span style="color:#66d9ef">null</span>) {
        NetMessage recievedMsg = <span style="color:#a6e22e">NetMessage</span>.DecodeMessage(inMsg);

        <span style="color:#75715e">//Sometimes we don&#39;t actually have a network message to process.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(recievedMsg == <span style="color:#66d9ef">null</span>) {
            <span style="color:#66d9ef">continue</span>;
        }

        <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">recievedMsg</span>.Category) {
            <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetMessageCategory</span>.Connection:
                <span style="color:#66d9ef">if</span>(OnConnectionMessage != <span style="color:#66d9ef">null</span>) {
                    OnConnectionMessage(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> NetMessageArgs(recievedMsg));
                }
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetMessageCategory</span>.Info:
                <span style="color:#66d9ef">if</span>(OnInfoMessage != <span style="color:#66d9ef">null</span>) {
                    OnInfoMessage(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> NetMessageArgs(recievedMsg));
                }
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetMessageCategory</span>.Lobby:
                <span style="color:#66d9ef">if</span>(OnLobbyMessage != <span style="color:#66d9ef">null</span>) {
                    OnLobbyMessage(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> NetMessageArgs(recievedMsg));
                }
                <span style="color:#66d9ef">break</span>;
        }

        Recycle(inMsg);
    }
}</code></pre></div>
<p>As each category is added this will be expanded upon but I can&rsquo;t see there being too many categories. By the end of this coming week I should have all lobby data synced along with a working chat system. This may seem fairly basic, and it really is because most of the magic is occuring in NetMessage.DecodeMessage(). DecodeMessage is similar to the factory pattern as it is responsible for creating every message recieved over the net.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// Decode a message that was recieved from over the network.
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> NetMessage DecodeMessage(NetIncomingMessage inMsg) {
    <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">inMsg</span>.MessageType) {
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetIncomingMessageType</span>.VerboseDebugMessage:
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetIncomingMessageType</span>.DebugMessage:
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetIncomingMessageType</span>.WarningMessage:
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetIncomingMessageType</span>.ErrorMessage:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> InfoMessage(inMsg);

        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetIncomingMessageType</span>.ConnectionApproval:
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetIncomingMessageType</span>.StatusChanged:
            <span style="color:#66d9ef">return</span> DecodeConnectionMessage(inMsg);

        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetIncomingMessageType</span>.Data:
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetIncomingMessageType</span>.UnconnectedData:
            <span style="color:#66d9ef">return</span> DecodeDataMessage(inMsg);

        <span style="color:#66d9ef">default</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
    }
}</code></pre></div>
<p>It takes an input of NetIncomingMessage (lidgren&rsquo;s message class) and converts them into the new custom message that is specialized. Info messages are nothing more than a string so they can be returned instantly. Things get a bit trickier with connection messages, and data messages though.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// Decodes a connection message such as connection request, connect,
</span><span style="color:#75715e">/// or disconnect that was recieved from over the network.
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> NetMessage DecodeConnectionMessage(NetIncomingMessage inMsg) {
    <span style="color:#66d9ef">if</span> (inMsg == <span style="color:#66d9ef">null</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
    }

    NetMessage connMsg = <span style="color:#66d9ef">null</span>;

    <span style="color:#75715e">//New client wants to connect
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">inMsg</span>.MessageType == <span style="color:#a6e22e">NetIncomingMessageType</span>.ConnectionApproval) {
        connMsg = <span style="color:#66d9ef">new</span> ConnectionRequestMessage(inMsg);
    }
    <span style="color:#75715e">//Client has fully connected, or wants to disconnect
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">inMsg</span>.MessageType == <span style="color:#a6e22e">NetIncomingMessageType</span>.StatusChanged) {
        NetConnectionStatus senderStatus = <span style="color:#a6e22e">inMsg</span>.<span style="color:#a6e22e">SenderConnection</span>.Status;

        <span style="color:#75715e">//Fully connected new client
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (senderStatus == <span style="color:#a6e22e">NetConnectionStatus</span>.Connected) {
            connMsg = <span style="color:#66d9ef">new</span> ConnectMessage(inMsg);
        }
        <span style="color:#75715e">//Old client leaving
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (senderStatus == <span style="color:#a6e22e">NetConnectionStatus</span>.Disconnected) {
            connMsg = <span style="color:#66d9ef">new</span> DisconnectMessage(inMsg);
        }
    }

    <span style="color:#66d9ef">return</span> connMsg;
}</code></pre></div>
<p>This method handles a few different tasks. It&rsquo;s responsible for processing ConnectionRequest, Connected, and Disconnect messages. A ConnectionRequestMessage occurs when a new client wants to join the server. This allows the server to get the player&rsquo;s desired name, and check if they are a known banned connection. Connection messages are nothing more than an acknowledgement that the client has joined in, but perhaps in the future they&rsquo;ll have some data attached to them. A Disconnect message is also nothing more than a courtesy to server instead of having the client time out.</p>

<p>Rebuilding data messages is simpler. It&rsquo;s nothing more than a switch statement that reads the first byte of each message to get the NetMessageType.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e">/// Decodes a custom data message that was recieved from over the network.
</span><span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> NetMessage DecodeDataMessage(NetIncomingMessage inMsg) {
    NetMessageType msgType = (NetMessageType)<span style="color:#a6e22e">inMsg</span>.ReadByte();

    <span style="color:#66d9ef">switch</span> (msgType) {
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetMessageType</span>.Chat:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> NetChatMessage(inMsg);

        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetMessageType</span>.Command:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> CommandMessage(inMsg);

        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetMessageType</span>.LobbySync:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> LobbySyncMessage(inMsg);

        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetMessageType</span>.PlayerJoined:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> PlayerJoinedMessage(inMsg);

        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">NetMessageType</span>.PlayerLeft:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> PlayerLeftMessage(inMsg);

        <span style="color:#66d9ef">default</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
    }
}</code></pre></div>
<p>In the near future once the network is solidified I plan on writing up a nice networking tutorial with Lidgren and Unity to help out others.</p>

  </section>
</article>

</main>


</div>

<footer style="position: relative; bottom: 0px; width: 100%;">
  <div class="container">
    <span class="copyright">&copy; 2018  Eddie Abbondanzio - <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
  </div>
</footer>

</body>
</html>

