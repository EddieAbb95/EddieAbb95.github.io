<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="description" content="My personal blog for all things related to software development, architecture, design patterns, web development, and more." />
  <title>No Mans Blocks - 4/8/18 &middot; Eddie Abbondanzio</title>
  <link rel="stylesheet" href="https://EddieAbbondanzio.github.io//css/style.css" />
  <link rel="stylesheet" href="https://EddieAbbondanzio.github.io//css/font-awesome.min.css" />
  <link href='https://fonts.googleapis.com/css?family=Lato:100,300,400,600' rel='stylesheet' type='text/css'>
</head>
<body>


<header class="header" style="background-color: rgb(46, 155, 218);  ;" role="banner">


      
      <section id="branding">
        <div id="site-title"><a href="https://EddieAbbondanzio.github.io/">Eddie Abbondanzio</a></div>
        <nav id="mainmenu">
          <ul>
            <li><a href="https://EddieAbbondanzio.github.io//about">About Me</a></li>
            <li><a href="http://github.com/EddieAbbondanzio" target="_blank">Github</a></li>
            <li><a href="https://twitter.com/EAbbondanzio" target="_blank">Twitter</a></li>
            <li><a href="https://www.linkedin.com/in/username" target="_blank">LinkedIn</a></li>
          </ul>
        </nav>
        <input type="checkbox" id="op"></input>
        <div class="lower">
          <label for="op">Menu</label>
        </div>
        <div class="overlay overlay-hugeinc">
          <label for="op"></label>
          <nav id="menu" role="navigation">
            <ul>
            <li><a href="https://EddieAbbondanzio.github.io/">Home</a></li>
            <li><a href="https://EddieAbbondanzio.github.io//about">About Me</a></li>
            <li><a href="http://github.com/EddieAbbondanzio" target="_blank">Github</a></li>
            <li><a href="https://twitter.com/EAbbondanzio" target="_blank">Twitter</a></li>
            <li><a href="https://www.linkedin.com/in/username" target="_blank">LinkedIn</a></li>
          </ul>
          </nav>
        </div>
        <div class="clearfix"></div>
      </section>

      <div class="header-overlay">
        <div class="post-heading">
          <h1>
          No Mans Blocks - 4/8/18
            <div class="share-icons-header">
              <a href="http://www.twitter.com/share?url=https%3a%2f%2fEddieAbbondanzio.github.io%2fpost%2fnomansblocks%2f4-8-18-update%2f" target="_blank">
              <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
              <g>
                <g>
                  <path d="M437.219,245.162c0-3.088-0.056-6.148-0.195-9.18c13.214-9.848,24.675-22.171,33.744-36.275
                    c-12.129,5.453-25.148,9.097-38.835,10.626c13.965-8.596,24.675-22.338,29.738-38.834c-13.075,7.928-27.54,13.603-42.924,16.552
                    c-12.323-14.021-29.904-22.95-49.35-23.284c-37.332-0.612-67.598,30.934-67.598,70.463c0,5.619,0.584,11.072,1.752,16.329
                    c-56.22-3.616-106.042-32.881-139.369-77c-5.814,10.571-9.152,22.922-9.152,36.164c0,25.037,11.934,47.291,30.071,60.421
                    c-11.099-0.5-21.503-3.866-30.627-9.375c0,0.306,0,0.612,0,0.918c0,34.996,23.312,64.316,54.245,71.159
                    c-5.675,1.613-11.656,2.448-17.804,2.421c-4.367-0.028-8.596-0.501-12.713-1.392c8.596,28.681,33.577,49.628,63.147,50.323
                    c-23.145,19.194-52.298,30.655-83.955,30.572c-5.453,0-10.849-0.361-16.135-1.029c29.933,20.53,65.456,32.491,103.65,32.491
                    C369.23,447.261,437.219,339.048,437.219,245.162z"/>
                  <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
                    C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
                    S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
                </g>
              </svg></a>
              <a href="http://plus.google.com/share?url=https%3a%2f%2fEddieAbbondanzio.github.io%2fpost%2fnomansblocks%2f4-8-18-update%2f" target="_blank">
              <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
                <g>
                  <g>
                    <path d="M349.146,402.251c0-30.016-17.387-44.815-36.525-60.922l-15.662-12.185c-4.785-3.895-11.294-9.124-11.294-18.693
                      c0-9.57,6.537-15.662,12.184-21.309c18.249-14.354,36.526-29.571,36.526-61.756c0-33.076-20.892-50.462-30.878-58.724l0,0h26.956
                      L358.271,153h-89.603c-23.479,0-53.049,3.478-77.863,23.924c-18.693,16.079-27.818,38.278-27.818,58.279
                      c0,33.911,26.093,68.294,72.188,68.294c4.368,0,9.125-0.445,13.937-0.863c-2.17,5.23-4.34,9.569-4.34,16.97
                      c0,13.464,6.955,21.753,13.047,29.57c-19.556,1.308-56.109,3.478-83.065,20.001c-25.676,15.217-33.493,37.416-33.493,53.077
                      c0,32.186,30.461,62.201,93.525,62.201C309.561,484.454,349.146,443.116,349.146,402.251z M255.621,291.34
                      c-37.415,0-54.384-48.292-54.384-77.418c0-11.322,2.17-23.034,9.569-32.186c6.955-8.707,19.139-14.382,30.461-14.382
                      c36.108,0,54.802,48.738,54.802,80.033c0,7.845-0.862,21.754-10.877,31.768C278.237,286.11,266.498,291.312,255.621,291.34z
                      M256.066,466.177c-46.54,0-76.556-22.171-76.556-53.049s27.846-41.311,37.416-44.787c18.276-6.093,41.755-6.982,45.677-6.982
                      c4.34,0,6.51,0,9.987,0.445c33.076,23.479,47.402,35.218,47.402,57.416C319.992,446.176,297.821,466.177,256.066,466.177z"/>
                    <polygon points="353.068,317.768 400.164,317.768 400.164,364.836 423.699,364.836 423.699,317.768 470.768,317.768 
                      470.768,294.233 423.699,294.233 423.699,247.165 400.164,247.165 400.164,294.233 353.068,294.233     "/>
                    <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
                      C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
                      S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
                  </g>
              </svg></a>
              <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fEddieAbbondanzio.github.io%2fpost%2fnomansblocks%2f4-8-18-update%2f" target="_blank">
              <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
              <g>
                <g>
                  <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
                    C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
                    S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
                  <path d="M317.739,482.617V306h58.279l9.208-58.529h-67.487v-29.348c0-15.272,5.007-29.849,26.928-29.849h43.813v-58.418h-62.201
                    c-52.298,0-66.569,34.438-66.569,82.175v35.413h-35.885V306h35.885v176.617H317.739L317.739,482.617z"/>
                </g>
              </svg>
              </a>
            </div>
            
          </h1>
        </div>
    </div>
    </header>

    <div id="container">


<section id="content" role="main">
<section class="entry-meta">
  <span class="post-date">Apr 8, 2018</span>
</section></header>
<section class="entry-content">
<article>


<h2 id="building-up-the-network-logic">Building Up the Network Logic</h2>

<p>While this week may not have much to show for it has built a solid foundation for networking. I spent some time refactoring the pre-existing network logic to try to clean things up. I really didn&rsquo;t like how the NetServerManager and NetClientManager derived from a base class of NetManager that had a NetMessageProcessor component. It was gross having to call that and subscribe to it&rsquo;s message events. I also didn&rsquo;t care for how each message had it&rsquo;s own event. To try to curtail this redundancy I came up with the following solution.</p>

<p>This networking set up is built on top of the Lidgren networking library. I wanted to abstract away from the Lidgren aspect since it&rsquo;s kinda low level, but I didn&rsquo;t want to go over the top at the same time. I based my setup from this <a href="https://dirkkok.wordpress.com/2012/02/20/lets-make-a-multiplayer-game-part-1/">site&rsquo;s</a> tutorial and applied a few custom tweaks to it.</p>

<p>To reduce redundant code and prevent potential logic errors from arising I changed NetMessage to an abstract class, and added a message category to the class. Now instead of requiring an unique event for each message type I only had to add one per category. Since most components of the game would require several messages it made sense to group them together instead of having to track multiple events per component.</p>

<p>The NetManager base class is responsible for checking and sending out message over the network. It allows for the server and client to be abstract away from the regular game logic as well. Below is the method for checking for messages.</p>

<pre><code class="language-c#">/// &lt;summary&gt;
/// Check to see if any messages have come in from the network.
/// &lt;/summary&gt;
public void CheckForMessages() {
    NetIncomingMessage inMsg;

    while((inMsg = ReadMessage()) != null) {
        NetMessage recievedMsg = NetMessage.DecodeMessage(inMsg);

        //Sometimes we don't actually have a network message to process.
        if(recievedMsg == null) {
            continue;
        }

        switch (recievedMsg.Category) {
            case NetMessageCategory.Connection:
                if(OnConnectionMessage != null) {
                    OnConnectionMessage(this, new NetMessageArgs(recievedMsg));
                }
                break;

            case NetMessageCategory.Info:
                if(OnInfoMessage != null) {
                    OnInfoMessage(this, new NetMessageArgs(recievedMsg));
                }
                break;

            case NetMessageCategory.Lobby:
                if(OnLobbyMessage != null) {
                    OnLobbyMessage(this, new NetMessageArgs(recievedMsg));
                }
                break;
        }

        Recycle(inMsg);
    }
}
</code></pre>

<p>As each category is added this will be expanded upon but I can&rsquo;t see there being too many categories. By the end of this coming week I should have all lobby data synced along with a working chat system. This may seem fairly basic, and it really is because most of the magic is occuring in NetMessage.DecodeMessage(). DecodeMessage is similar to the factory pattern as it is responsible for creating every message recieved over the net.</p>

<pre><code class="language-c#">/// &lt;summary&gt;
/// Decode a message that was recieved from over the network.
/// &lt;/summary&gt;
public static NetMessage DecodeMessage(NetIncomingMessage inMsg) {
    switch (inMsg.MessageType) {
        case NetIncomingMessageType.VerboseDebugMessage:
        case NetIncomingMessageType.DebugMessage:
        case NetIncomingMessageType.WarningMessage:
        case NetIncomingMessageType.ErrorMessage:
            return new InfoMessage(inMsg);

        case NetIncomingMessageType.ConnectionApproval:
        case NetIncomingMessageType.StatusChanged:
            return DecodeConnectionMessage(inMsg);

        case NetIncomingMessageType.Data:
        case NetIncomingMessageType.UnconnectedData:
            return DecodeDataMessage(inMsg);

        default:
            return null;
    }
}
</code></pre>

<p>It takes an input of NetIncomingMessage (lidgren&rsquo;s message class) and converts them into the new custom message that is specialized. Info messages are nothing more than a string so they can be returned instantly. Things get a bit trickier with connection messages, and data messages though.</p>

<pre><code class="language-c#">/// &lt;summary&gt;
/// Decodes a connection message such as connection request, connect,
/// or disconnect that was recieved from over the network.
/// &lt;/summary&gt;
private static NetMessage DecodeConnectionMessage(NetIncomingMessage inMsg) {
    if (inMsg == null) {
        return null;
    }

    NetMessage connMsg = null;

    //New client wants to connect
    if (inMsg.MessageType == NetIncomingMessageType.ConnectionApproval) {
        connMsg = new ConnectionRequestMessage(inMsg);
    }
    //Client has fully connected, or wants to disconnect
    else if (inMsg.MessageType == NetIncomingMessageType.StatusChanged) {
        NetConnectionStatus senderStatus = inMsg.SenderConnection.Status;

        //Fully connected new client
        if (senderStatus == NetConnectionStatus.Connected) {
            connMsg = new ConnectMessage(inMsg);
        }
        //Old client leaving
        else if (senderStatus == NetConnectionStatus.Disconnected) {
            connMsg = new DisconnectMessage(inMsg);
        }
    }

    return connMsg;
}
</code></pre>

<p>This method handles a few different tasks. It&rsquo;s responsible for processing ConnectionRequest, Connected, and Disconnect messages. A ConnectionRequestMessage occurs when a new client wants to join the server. This allows the server to get the player&rsquo;s desired name, and check if they are a known banned connection. Connection messages are nothing more than an acknowledgement that the client has joined in, but perhaps in the future they&rsquo;ll have some data attached to them. A Disconnect message is also nothing more than a courtesy to server instead of having the client time out.</p>

<p>Rebuilding data messages is simpler. It&rsquo;s nothing more than a switch statement that reads the first byte of each message to get the NetMessageType.</p>

<pre><code class="language-c#">/// &lt;summary&gt;
/// Decodes a custom data message that was recieved from over the network.
/// &lt;/summary&gt;
private static NetMessage DecodeDataMessage(NetIncomingMessage inMsg) {
    NetMessageType msgType = (NetMessageType)inMsg.ReadByte();

    switch (msgType) {
        case NetMessageType.Chat:
            return new NetChatMessage(inMsg);

        case NetMessageType.Command:
            return new CommandMessage(inMsg);

        case NetMessageType.LobbySync:
            return new LobbySyncMessage(inMsg);

        case NetMessageType.PlayerJoined:
            return new PlayerJoinedMessage(inMsg);

        case NetMessageType.PlayerLeft:
            return new PlayerLeftMessage(inMsg);

        default:
            return null;
    }
}
</code></pre>

<p>In the near future once the network is solidified I plan on writing up a nice networking tutorial with Lidgren and Unity to help out others.</p>

</section>
<div class="entry-links"></div>
</article>
<div class="share-icons-body">
  <a href="http://www.twitter.com/share?url=https%3a%2f%2fEddieAbbondanzio.github.io%2fpost%2fnomansblocks%2f4-8-18-update%2f" target="_blank">
  <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
  <g>
    <g>
      <path d="M437.219,245.162c0-3.088-0.056-6.148-0.195-9.18c13.214-9.848,24.675-22.171,33.744-36.275
        c-12.129,5.453-25.148,9.097-38.835,10.626c13.965-8.596,24.675-22.338,29.738-38.834c-13.075,7.928-27.54,13.603-42.924,16.552
        c-12.323-14.021-29.904-22.95-49.35-23.284c-37.332-0.612-67.598,30.934-67.598,70.463c0,5.619,0.584,11.072,1.752,16.329
        c-56.22-3.616-106.042-32.881-139.369-77c-5.814,10.571-9.152,22.922-9.152,36.164c0,25.037,11.934,47.291,30.071,60.421
        c-11.099-0.5-21.503-3.866-30.627-9.375c0,0.306,0,0.612,0,0.918c0,34.996,23.312,64.316,54.245,71.159
        c-5.675,1.613-11.656,2.448-17.804,2.421c-4.367-0.028-8.596-0.501-12.713-1.392c8.596,28.681,33.577,49.628,63.147,50.323
        c-23.145,19.194-52.298,30.655-83.955,30.572c-5.453,0-10.849-0.361-16.135-1.029c29.933,20.53,65.456,32.491,103.65,32.491
        C369.23,447.261,437.219,339.048,437.219,245.162z"/>
      <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
        C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
        S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
    </g>
  </svg></a>
  <a href="http://plus.google.com/share?url=https%3a%2f%2fEddieAbbondanzio.github.io%2fpost%2fnomansblocks%2f4-8-18-update%2f" target="_blank">
  <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
    <g>
      <g>
        <path d="M349.146,402.251c0-30.016-17.387-44.815-36.525-60.922l-15.662-12.185c-4.785-3.895-11.294-9.124-11.294-18.693
          c0-9.57,6.537-15.662,12.184-21.309c18.249-14.354,36.526-29.571,36.526-61.756c0-33.076-20.892-50.462-30.878-58.724l0,0h26.956
          L358.271,153h-89.603c-23.479,0-53.049,3.478-77.863,23.924c-18.693,16.079-27.818,38.278-27.818,58.279
          c0,33.911,26.093,68.294,72.188,68.294c4.368,0,9.125-0.445,13.937-0.863c-2.17,5.23-4.34,9.569-4.34,16.97
          c0,13.464,6.955,21.753,13.047,29.57c-19.556,1.308-56.109,3.478-83.065,20.001c-25.676,15.217-33.493,37.416-33.493,53.077
          c0,32.186,30.461,62.201,93.525,62.201C309.561,484.454,349.146,443.116,349.146,402.251z M255.621,291.34
          c-37.415,0-54.384-48.292-54.384-77.418c0-11.322,2.17-23.034,9.569-32.186c6.955-8.707,19.139-14.382,30.461-14.382
          c36.108,0,54.802,48.738,54.802,80.033c0,7.845-0.862,21.754-10.877,31.768C278.237,286.11,266.498,291.312,255.621,291.34z
           M256.066,466.177c-46.54,0-76.556-22.171-76.556-53.049s27.846-41.311,37.416-44.787c18.276-6.093,41.755-6.982,45.677-6.982
          c4.34,0,6.51,0,9.987,0.445c33.076,23.479,47.402,35.218,47.402,57.416C319.992,446.176,297.821,466.177,256.066,466.177z"/>
        <polygon points="353.068,317.768 400.164,317.768 400.164,364.836 423.699,364.836 423.699,317.768 470.768,317.768 
          470.768,294.233 423.699,294.233 423.699,247.165 400.164,247.165 400.164,294.233 353.068,294.233     "/>
        <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
          C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
          S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
      </g>
  </svg></a>
  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fEddieAbbondanzio.github.io%2fpost%2fnomansblocks%2f4-8-18-update%2f" target="_blank">
  <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
     viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
  <g>
    <g>
      <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
        C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
        S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
      <path d="M317.739,482.617V306h58.279l9.208-58.529h-67.487v-29.348c0-15.272,5.007-29.849,26.928-29.849h43.813v-58.418h-62.201
        c-52.298,0-66.569,34.438-66.569,82.175v35.413h-35.885V306h35.885v176.617H317.739L317.739,482.617z"/>
    </g>
  </svg>
  </a>
</div>
<div class="clearfix"></div>
<figure class="author-bio">
<img class="bio-image" src="https://EddieAbbondanzio.github.io/img/avatar.jpg" />
<figcaption class="bio-text">My name&#39;s Eddie Abbondanzio, and I&#39;m a full time Software Developer. Programming is my favorite hobby, and I love working on anything web related, and my own personal projects. If I&#39;m not programming, then I&#39;m likely working on one of my cars.</figcaption>
</figure>
<hr>

</section>
<div class="clear"></div>
</div>
<footer id="footer" style="color: #7A7B7C; background-color: #141414;background-repeat: repeat, no-repeat; background-position: left top, left top; background-size: 100px 100px, 100% 100%;">
  <div id="footer-container">
    <div class="footer-column">Some text here.</div>
    <div class="footer-column">Some different text here.</div>
    <div class="footer-column">Even more different text here.</div>
    <div class="clearfix"></div>
  </div>
  <div id="copyright">&copy; 2019. All rights reserved.</div>

</footer>
<script src="https://EddieAbbondanzio.github.io//js/highlight.pack.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
      m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-128571017-1', 'auto');
  ga('send', 'pageview');
</script>

</div>
</body>
<link rel="shortcut icon" href="https://EddieAbbondanzio.github.io//img/favicon.ico" />
<link rel="apple-touch-icon" href="https://EddieAbbondanzio.github.io//img/apple-touch-icon.jpg" />

</html>