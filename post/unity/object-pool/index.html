<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="author" content="">
    <meta name="generator" content="Hugo 0.37" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://EddieAbb95.github.io/css/style.css" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type="text/css">
    <link rel="alternate" href="https://EddieAbb95.github.io/index.xml" type="application/rss+xml" title="Eddie Abbondanzio">

    <title>
        
        Object Pooling in Unity  - Eddie Abbondanzio 
    </title>
</head>
    
<body>
    <header>
        <div class="container clearfix">
        
        <a class="path" href="https://EddieAbb95.github.io/">Home</a>

        
        <div class="right">
            
            
            
            
            
            <a class="path" href="/page/about/">About Me</a>
        </div>
      </div>
    </header>

<div class="container">


<main role="main" class="article">
  
<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2018-03-30">March 30, 2018</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="https://EddieAbb95.github.io/categories/unity">Unity</a>

    </span>


  </div>
  <h1 class="headline" itemprop="headline">Object Pooling in Unity</h1>
  <section class="body" itemprop="articleBody" style="width: 100%;">
    

<h2 id="gameobject-instantiate-is-expensive">GameObject.Instantiate() is Expensive</h2>

<p>Creating new gameobjects during runtime can be a costly operation. Multiple this action by 10 or more times in a single frame and you&rsquo;ll notice a slight hiccup in FPS. One option to counter this is by taking advantage of object pooling. Object pooling is when a collection of inactive gameobjects is kept on standby. When the game needs a new object it can call upon the pool to let it use one of the objects in it. Then when finished, the object can be returned back to the pool.</p>

<p>To prepare my project for some of the new features coming up I decided to finally implement a better method for handling my various object pools throughout the game. This implementation doesn&rsquo;t use any data structure to maintain references of the objects. Instead objects that are in use are kept at the top of the child list, and objects that are inactive are kept at the bottom. This allows us to track the next available object with an integer. Since you&rsquo;ll probably have more than one object pool, let&rsquo;s start by creating an easy way to differentiate between our objects (prefabs). To do this we&rsquo;ll create an enum.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> PrefabType : <span style="color:#66d9ef">byte</span> {
    Chunk = <span style="color:#ae81ff">0</span>
}</code></pre></div>
<p>I defined a chunk prefab type as this is being used in a voxel game and there is roughly 500 chunk gameobjects that need to be kept track of. The names aren&rsquo;t important as long as their unique. Now lets start with the object pool class.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PrefabPool</span> : MonoBehaviour {
    <span style="color:#75715e">#region Properties
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// The type of prefab the pool contains.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> PrefabType Type;

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// The target size of the pool. 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Size;

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// The prefab of the pool.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> GameObject Prefab;
    <span style="color:#75715e">#endregion
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">#region Members
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// The current index of the next available
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// instance.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> currentInstance;

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// If instances are being added to the pool.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">bool</span> addingInstances;

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// If instances are being removed from the pool.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">bool</span> removingInstances;
    <span style="color:#75715e">#endregion
</span><span style="color:#75715e"></span>}</code></pre></div>
<p>First thing we&rsquo;ll want to do is set up the local variables. It comes down to personal preference but I like to initialize things local to the object in Awake() and
then initialize components that rely on other objects in Start(). It just helps reduce potential issues that can arise.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Sets the pool up.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Awake() {
        addingInstances = <span style="color:#66d9ef">false</span>;
        removingInstances = <span style="color:#66d9ef">false</span>;

        currentInstance = <span style="color:#ae81ff">0</span>;
    }</code></pre></div>
<p>Then in Update() well want to manage the size of the pool. During periods of high demand the pool can grow, so when things slow down we&rsquo;ll want to reduce it&rsquo;s size back to the preset.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Update() {
        <span style="color:#66d9ef">if</span> (!addingInstances &amp;&amp; !removingInstances) { 
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">transform</span>.childCount != Size &amp;&amp; currentInstance &lt; Size) {
                UpdatePoolSize();
            }
        }
    }</code></pre></div>
<p>Lastly we need the pool to have the correct number of objects in it before the scene begins. This is where OnValidate() comes in handy. OnValidate() is called when a public field is modified on the MonoBehaviour. We can use this to add or remove objects from the pool.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Called when an editor field is modified.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> OnValidate() {
        <span style="color:#75715e">//Ensure pool is greater than or equal to 1.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(Size &lt; <span style="color:#ae81ff">1</span>) {
            Size = <span style="color:#ae81ff">1</span>;
        }

        UpdatePoolSize();
    }</code></pre></div>
<p>Unity however doesn&rsquo;t like it when we attempt to destroy objects in OnValidate(). Therefore we have to work around this by changing pool size via a coroutine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Gets the pool size back to it&#39;s correct value.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> UpdatePoolSize() {
        <span style="color:#75715e">//Add some if we need it.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">transform</span>.childCount &lt; Size) {
            StartCoroutine(AddInstances(Size - <span style="color:#a6e22e">transform</span>.childCount));
        }
        <span style="color:#75715e">//Remove some theres too many
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">transform</span>.childCount &gt; Size) {
            StartCoroutine(RemoveInstances(<span style="color:#a6e22e">transform</span>.childCount - Size));
        }
    }</code></pre></div>
<p>The two coroutines are defined as below. The first yield return null may seem useless, but it&rsquo;s required for updating the pool correctly when in the editor. Since the size of the pool can&rsquo;t be changed instantly, we need to keep track via the two bools. If desired it could be reduced to a single bool flag.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Adds several new instance to the pool.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> IEnumerator AddInstances(<span style="color:#66d9ef">int</span> count) {
        addingInstances = <span style="color:#66d9ef">true</span>;

        <span style="color:#66d9ef">yield</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;

        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; count; i++) {
            AddInstance();

            <span style="color:#66d9ef">if</span> (i != <span style="color:#ae81ff">0</span> &amp;&amp; i % <span style="color:#ae81ff">16</span> == <span style="color:#ae81ff">0</span>) {
                <span style="color:#66d9ef">yield</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
            }
        }

        addingInstances = <span style="color:#66d9ef">false</span>;
    }


    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Removes more than 1 instance in the pool.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> IEnumerator RemoveInstances(<span style="color:#66d9ef">int</span> count) {
        removingInstances = <span style="color:#66d9ef">true</span>;

        <span style="color:#66d9ef">yield</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;

        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; count; i++) {
            RemoveInstance();

            <span style="color:#66d9ef">if</span>(i != <span style="color:#ae81ff">0</span> &amp;&amp; i % <span style="color:#ae81ff">16</span> == <span style="color:#ae81ff">0</span>) {
                <span style="color:#66d9ef">yield</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>; 
            }
        }

        removingInstances = <span style="color:#66d9ef">false</span>;
    }</code></pre></div>
<p>Now lets add the helper methods. You may want to add some null checks here.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Add another instance to the pool.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> AddInstance() {
        GameObject newInstance = <span style="color:#a6e22e">GameObject</span>.Instantiate(Prefab, <span style="color:#66d9ef">this</span>.transform);
        <span style="color:#a6e22e">newInstance</span>.SetActive(<span style="color:#66d9ef">false</span>);
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Remove an instance, ensure it&#39;s inactive first.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> RemoveInstance() {
        GameObject lastInstance = <span style="color:#a6e22e">transform</span>.GetChild(currentInstance).gameObject;

        <span style="color:#66d9ef">if</span> (!<span style="color:#a6e22e">lastInstance</span>.activeSelf) {
            DestroyImmediate(lastInstance);
        }
    }</code></pre></div>
<p>So far the pool is able to grow and shrink as needed, but there&rsquo;s still no way to retrieve an object from it. We&rsquo;ll add a couple overloads to allow the position of the object to be predefined, and even allow the object to be set as static.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Returns an instance from the pool. If the
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// pool is of fixed type, it may return null.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> GameObject GetPooledInstance() {
        <span style="color:#66d9ef">return</span> GetInstance();
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Returns an instance from the pool at the
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// desired location. If the pool is fixed,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// and it may return null.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> GameObject GetPooledInstance(Vector3 pos) {
        GameObject instance = GetInstance();
        <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">transform</span>.position = pos;

        <span style="color:#66d9ef">return</span> instance;
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Returns an instance from the pool at the desired location.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// If the pool is fixed, it may return null. The prefab is also
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// set to static.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> GameObject GetPooledInstance(Vector3 pos, <span style="color:#66d9ef">bool</span> isStatic) {
        GameObject instance = GetInstance();
        <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">transform</span>.position = pos;
        <span style="color:#a6e22e">instance</span>.isStatic = isStatic;

        <span style="color:#66d9ef">return</span> instance;
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Return an instance back to the pool.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ReturnInstance(GameObject obj) {
        <span style="color:#66d9ef">if</span>(obj == <span style="color:#66d9ef">null</span>) {
            <span style="color:#66d9ef">return</span>;
        }

        PrefabInstance instance = <span style="color:#a6e22e">obj</span>.GetComponent&lt;PrefabInstance&gt;();
        <span style="color:#66d9ef">if</span>(instance?.Type == Type &amp;&amp; instance?.Pool == <span style="color:#66d9ef">this</span>) {
            <span style="color:#a6e22e">obj</span>.SetActive(<span style="color:#66d9ef">false</span>);
            currentInstance--;

            <span style="color:#a6e22e">obj</span>.isStatic = <span style="color:#66d9ef">false</span>;
            <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">transform</span>.SetSiblingIndex(currentInstance);
            <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">transform</span>.position = <span style="color:#a6e22e">Vector3</span>.zero;
        }
    }

    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Get an instance from the pool. If the pool has none
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// to give out, create one.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> GameObject GetInstance() {
        <span style="color:#66d9ef">if</span>(currentInstance == <span style="color:#a6e22e">transform</span>.childCount) {
            AddInstance();
        }

        GameObject instance = <span style="color:#a6e22e">transform</span>.GetChild(currentInstance).gameObject;
        <span style="color:#a6e22e">instance</span>.SetActive(<span style="color:#66d9ef">true</span>);

        PrefabInstance prefabInstance = <span style="color:#a6e22e">instance</span>.GetComponent&lt;PrefabInstance&gt;();
        <span style="color:#66d9ef">if</span>(prefabInstance != <span style="color:#66d9ef">null</span>) {
            <span style="color:#a6e22e">prefabInstance</span>.Pool = <span style="color:#66d9ef">this</span>;
        }

        currentInstance++;
        <span style="color:#66d9ef">return</span> instance;
    }</code></pre></div>
<p>And lastly we&rsquo;ll need a way to return objects to the pool.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Return an instance back to the pool.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ReturnInstance(GameObject obj) {
        <span style="color:#66d9ef">if</span>(obj == <span style="color:#66d9ef">null</span>) {
            <span style="color:#66d9ef">return</span>;
        }

        PrefabInstance instance = <span style="color:#a6e22e">obj</span>.GetComponent&lt;PrefabInstance&gt;();
        <span style="color:#66d9ef">if</span>(instance?.Type == Type &amp;&amp; instance?.Pool == <span style="color:#66d9ef">this</span>) {
            <span style="color:#a6e22e">obj</span>.SetActive(<span style="color:#66d9ef">false</span>);
            currentInstance--;

            <span style="color:#a6e22e">obj</span>.isStatic = <span style="color:#66d9ef">false</span>;
            <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">transform</span>.SetSiblingIndex(currentInstance);
            <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">transform</span>.position = <span style="color:#a6e22e">Vector3</span>.zero;
        }
    }</code></pre></div>
<p>And the pool should now be fully functional. You&rsquo;ll likely want to make some tweaks, but you should work on adding some kind of controller to centralize access to all the pools in the event you have more one.</p>

  </section>
</article>

</main>


</div>

<footer style="position: relative; bottom: 0px; width: 100%;">
  <div class="container">
    <span class="copyright">&copy; 2018  Eddie Abbondanzio - <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
  </div>
</footer>

</body>
</html>

